<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Enrollment | Nsuta Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const activeUser = JSON.parse(localStorage.getItem("activeUser"));
    if (!sessionStorage.getItem("role") && activeUser?.role === "headteacher") {
      sessionStorage.setItem("username", activeUser.username);
      sessionStorage.setItem("role", activeUser.role);
    }
  </script>
  <script src="guard.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f9ff;
      padding: 20px;
      max-width: 950px;
      margin: auto;
    }
    h2, h3 {
      color: #0077cc;
      margin-bottom: 15px;
    }
    input, select {
      padding: 8px;
      margin: 5px;
      font-size: 14px;
    }
    button {
      padding: 8px 14px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #0077cc;
      color: white;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #005fa3; }
    #confirmBtn { background: #28a745; }
    #confirmBtn:hover { background: #218838; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th { background-color: #e0ecf9; }
    .action-btn {
      background: crimson;
      padding: 4px 10px;
      font-size: 13px;
      margin-left: 5px;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .action-btn:hover { background: #a30000; }
    #uploadStatus, #feedback {
      margin-top: 10px;
      font-weight: bold;
    }
    #photoPreview img {
      border: 1px solid #ccc;
      margin-top: 8px;
      width: 100px;
      height: 100px;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <h2>üìò Student Enrollment</h2>

  <h3>üìÇ Upload Students from CSV</h3>
  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="previewCSV()">Preview CSV</button>
  <div id="csvPreview"></div>
  <button id="confirmBtn" style="display:none;" onclick="confirmUpload()">‚úÖ Confirm Upload</button>
  <div id="uploadStatus"></div>

  <h3>‚ûï Add New Student</h3>
  <input type="text" id="idInput" placeholder="Student ID" />
  <input type="text" id="nameInput" placeholder="Full Name" />
  <select id="classInput">
    <option value="">Select Class</option>
    <option>JHS1</option>
    <option>JHS2</option>
    <option>JHS3</option>
  </select>
  <select id="genderInput">
    <option value="">Select Gender</option>
    <option>Male</option>
    <option>Female</option>
  </select>
  <input type="password" id="pinInput" maxlength="4" placeholder="4-digit PIN" />
  <input type="text" id="photoInput" placeholder="Photo URL (optional)" />
  <div id="photoPreview">
    <img src="assets/default-photo.png" id="previewImg" alt="Preview" />
  </div>
  <button onclick="addStudent()">Add Student</button>
  <div id="feedback"></div>

  <button onclick="exportStudents()" style="float:right;">‚¨áÔ∏è Export as CSV</button>

  <h3 style="margin-top:50px;">üßæ All Enrolled Students</h3>
  <table id="studentTable">
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Class</th><th>Gender</th><th>PIN</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const SUPABASE_URL = "https://iguspjforzyndedxafdi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlndXNwamZvcnp5bmRlZHhhZmRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MDc5MzksImV4cCI6MjA2NzE4MzkzOX0.h_OF0GcsaXPJm7OuuA3fCz4FaXV3_VBXG_WLr0zafVE";

    let previewData = [];

    function previewCSV() {
      const file = document.getElementById("csvFile").files[0];
      const preview = document.getElementById("csvPreview");
      const confirmBtn = document.getElementById("confirmBtn");
      const uploadStatus = document.getElementById("uploadStatus");

      preview.innerHTML = "";
      uploadStatus.textContent = "";
      previewData = [];

      if (!file) return alert("Please select a CSV file.");

      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.trim().split("\n");
        const hasHeader = lines[0].toLowerCase().includes("id");
        const startIndex = hasHeader ? 1 : 0;
        let html = "<table><tr><th>ID</th><th>Name</th><th>Class</th><th>Gender</th><th>PIN</th></tr>";

        for (let i = startIndex; i < lines.length; i++) {
          const [id, name, cls, gender, pin] = lines[i].split(",").map(p => p?.trim());
          if (id && name && cls && gender && /^\d{4}$/.test(pin)) {
            const student = { student_id: id, full_name: name, class: cls, gender, pin };
            previewData.push(student);
            html += `<tr><td>${id}</td><td>${name}</td><td>${cls}</td><td>${gender}</td><td>${pin}</td></tr>`;
          }
        }

        html += "</table>";
        preview.innerHTML = html;
        confirmBtn.style.display = previewData.length > 0 ? "inline-block" : "none";
        if (previewData.length === 0) alert("‚ö†Ô∏è No valid student rows detected.");
      };

      reader.readAsText(file);
    }

    function confirmUpload() {
      if (previewData.length === 0) return;
      let existing = JSON.parse(localStorage.getItem("studentList")) || [];
      previewData = previewData.filter(p => !existing.some(e => e.student_id === p.student_id));
      const updated = [...existing, ...previewData];

      localStorage.setItem("studentList", JSON.stringify(updated));
      document.getElementById("uploadStatus").textContent = `‚úÖ ${previewData.length} new students added.`;
      document.getElementById("csvFile").value = "";
      document.getElementById("csvPreview").innerHTML = "";
      document.getElementById("confirmBtn").style.display = "none";
      loadStudents();
    }

    function addStudent() {
      const id = document.getElementById("idInput").value.trim();
      const name = document.getElementById("nameInput").value.trim();
      const cls = document.getElementById("classInput").value;
      const gender = document.getElementById("genderInput").value;
      const pin = document.getElementById("pinInput").value.trim();
      const photo = document.getElementById("photoInput").value.trim();
      const feedback = document.getElementById("feedback");

      if (!id || !name || !cls || !gender || !/^\d{4}$/.test(pin)) {
        feedback.textContent = "‚ö†Ô∏è Fill in all fields correctly. PIN must be 4 digits.";
        feedback.style.color = "crimson";
        return;
      }

     async function addStudentToSupabase(student) {
  const { data, error } = await supabase
    .from("students")
    .insert([student]);

  if (error) {
    alert("‚ùå Failed to save student: " + error.message);
  } else {
    alert("‚úÖ Student saved to Supabase.");
  }
}

      students.push({
        student_id: id,
        full_name: name,
        class: cls,
        gender,
        pin,
        photo: photo || "assets/default-photo.png"
      });

      localStorage.setItem("studentList", JSON.stringify(students));
      loadStudents();

      document.getElementById("idInput").value = "";
      document.getElementById("nameInput").value = "";
      document.getElementById("classInput").value = "";
      document.getElementById("genderInput").value = "";
      document.getElementById("pinInput").      document.getElementById("pinInput").value = "";
      document.getElementById("photoInput").value = "";
      document.getElementById("previewImg").src = "assets/default-photo.png";
      feedback.textContent = "‚úÖ Student added successfully.";
      feedback.style.color = "green";
    }

    document.getElementById("photoInput").addEventListener("input", e => {
      const url = e.target.value.trim();
      document.getElementById("previewImg").src = url || "assets/default-photo.png";
    });

    function loadStudents() {
      const students = JSON.parse(localStorage.getItem("studentList")) || [];
      const tbody = document.querySelector("#studentTable tbody");
      tbody.innerHTML = "";

      students.forEach((s, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input value="${s.student_id}" onchange="editStudent(${index}, 'student_id', this.value)" /></td>
          <td><input value="${s.full_name}" onchange="editStudent(${index}, 'full_name', this.value)" /></td>
          <td>
            <select onchange="editStudent(${index}, 'class', this.value)">
              <option ${s.class === "JHS1" ? "selected" : ""}>JHS1</option>
              <option ${s.class === "JHS2" ? "selected" : ""}>JHS2</option>
              <option ${s.class === "JHS3" ? "selected" : ""}>JHS3</option>
            </select>
          </td>
          <td>
            <select onchange="editStudent(${index}, 'gender', this.value)">
              <option ${s.gender === "Male" ? "selected" : ""}>Male</option>
              <option ${s.gender === "Female" ? "selected" : ""}>Female</option>
            </select>
          </td>
          <td><input value="${s.pin || ''}" onchange="editStudent(${index}, 'pin', this.value)" /></td>
          <td><button class="action-btn" onclick="removeStudent(${index})">Remove</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function editStudent(index, key, value) {
      const students = JSON.parse(localStorage.getItem("studentList")) || [];
      students[index][key] = value;
      localStorage.setItem("studentList", JSON.stringify(students));
    }

    function removeStudent(index) {
      const students = JSON.parse(localStorage.getItem("studentList")) || [];
      students.splice(index, 1);
      localStorage.setItem("studentList", JSON.stringify(students));
      loadStudents();
    }

    function exportStudents() {
      const students = JSON.parse(localStorage.getItem("studentList")) || [];
      if (students.length === 0) return alert("No student data available.");

      let csvContent = "ID,Name,Class,Gender,PIN\n";
      students.forEach(s => {
        csvContent += `${s.student_id},${s.full_name},${s.class},${s.gender},${s.pin || ""}\n`;
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "Nsuta_Student_List.csv";
      link.click();
    }

    window.onload = loadStudents;
  </script>
</body>
</html>
